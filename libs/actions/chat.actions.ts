import connectdb from "@/utils/database/dbconnect";
import User from "../model/User";
import { currentUser } from "@clerk/nextjs";
import Conversation from "../model/Conversation";
import mongoose from "mongoose";
import { fetchuserfromclerkid } from "./user.actions";
import { redirect } from "next/navigation";
import Message from "../model/Message";
import { pusherServer } from "@/utils/pusher/pusher";
import { revalidatePath } from "next/cache";

export async function getallusers(){
    const user:any=await currentUser();
    try{
        await connectdb();
        const users=await User.find({clerkid:{$ne:user.id}},{name:1,username:1,profilepic:1,_id:1,clerkid:1});
        return users;
    }catch(err:any){
        return [];
    }
}

interface createuserprops{
    members:any[],
    isgroupchat?:boolean,
    groupname?:string,
    groupicon?:string
}


export async function createconversation({
    members,
    isgroupchat,
    groupname,
    groupicon
}:createuserprops){
  //  members=[new mongoose.Types.ObjectId(members[0]),new mongoose.Types.ObjectId(members[1])]
    try{
      await connectdb();

      if(isgroupchat){
        if(!groupname || !groupicon || !members || members.length<2){
            // for creating group atleast 3 members required
            return null;
        }
        const user=await currentUser();
        if(!user){
            return redirect('/sign-in');
        }
        const creatinguser=await fetchuserfromclerkid(user.id);
        members=members.map((member)=>new mongoose.Types.ObjectId(member.value));
        members.push(creatinguser._id);
       const newconversation= await Conversation.create({
            groupicon:groupicon,
            groupname:groupname,
            isgroupchat:true,
            members:members
        })
        return newconversation._id ;
      }
     





    // check for if conversation already exists
      const isconversationexists=await Conversation.find({
        $or:[
            {members:{$all:[members[0],members[1]]}},
            {members:{$all:[members[1],members[0]]}}
        ]
      })
    
      if(isconversationexists.length>0){
        return isconversationexists[0]._id
      }
      const newconversation=await Conversation.create({
        members:Array.from(members)
      })
      return newconversation._id;
    }catch(err){
        console.log("Error while creating conversation","=>",err)
        return null;
    }
}

export async function getallconversation(){
  const user:any=await currentUser();
  if(!user){
    redirect('/sign-in')
  }
  const userfromclerkid=await fetchuserfromclerkid(user.id);
  if(!userfromclerkid){
    redirect('/sign-in')
  }
  try{
    await connectdb();
    const conversations=await Conversation.find({members:userfromclerkid._id}).populate({
      path:"members",
      model:User,
      select:"username name profilepic clerkid"
    }).populate({
      path:"lastmessageid",
      model:Message,
    }).sort({lastupdatedon:-1});
    revalidatePath('/conversation')
    return {conversations,currentuser:userfromclerkid._id};
  }catch(err){
    return null;
  }

}



export async function getallmessageofaconversation(conversationid:string){
   try{
     if(!conversationid){
      return null;
     }
     const user=await currentUser();
     if(!user){
      redirect('/sign-in')
     }
     const currentuser=await fetchuserfromclerkid(user.id);
     if(!currentuser){
      redirect('/sign-in')
     }
     await connectdb();
      const conversation=await Conversation.findById({_id:conversationid}).populate({
        path:'messages',
        model:Message,
        options:{$sort:{createdon:-1}}
      }).populate({
        path:'members',
        model:User,
        select:'name username profilepic _id clerkid'
      })

      if(!conversation){
        return null
      }
      return {members:conversation?.members,currentuser:currentuser._id,messages:conversation?.messages,isgroupchat:conversation?.isgroupchat,groupname:conversation?.groupname,groupicon:conversation?.groupicon}
   }catch(err){
      console.log("Error while getting all messages","=>",err)
      return null;
   }
}


 interface createmessageprops{
  conversationid:string,
  text?:string,
  media?:any,
  createdby:string
}


export async  function createmessage({conversationid,text,media,createdby}:createmessageprops){
  try{
       console.log("create message called",createdby)
       await connectdb();
       let createprops:any={
        createdby:createdby,
        conversation:conversationid,
        seenby:[createdby]
       };
       
       if(text){
        createprops={...createprops,text:text}
      }else{
        createprops={...createprops,media:media}
      }
       const newmessage=await Message.create({
           ...createprops
       })
       if(!newmessage){
             return null;  
       }
       const updatedconversation=await Conversation.findByIdAndUpdate({_id:conversationid},{
        lastupdatedon:Date.now(),
        lastmessageid:newmessage._id,
        $push:{messages:newmessage._id}
       })

       await pusherServer.trigger(conversationid,'messages:new',newmessage);
       updatedconversation.members.forEach(async (userid:any) => {
         await pusherServer.trigger(userid.toString(),'conversation:update',newmessage)
       });
       return newmessage;
  }catch(err){
    console.log("Error while crearting amessage","=>",err)
    return null;
  }
}
    
  
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
  